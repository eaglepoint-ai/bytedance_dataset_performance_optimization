name: Validate PR Template

on:
  pull_request:
    branches: 
        - main
        - main-test
    types:
      - opened
      - edited
      - synchronize
      - reopened

jobs:
  validate-pr-template:
    name: Validate dataset PR fields
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository (needed for gh context)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate PR description for required dataset fields
        id: validate
        env:
          PR_BODY: ${{ github.event.pull_request.body || '' }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          python - <<'PY'
          import json
          import os
          import re
          import subprocess
          import sys
          import textwrap

          body = os.environ.get("PR_BODY", "") or ""
          pr_number = os.environ["PR_NUMBER"]
          repo = os.environ["REPO"]
          gh_token = os.environ.get("GH_TOKEN")
          gout = os.environ.get("GITHUB_OUTPUT")

          errors = []

          def delete_comments_with_prefixes(prefixes):
              """Delete bot comments starting with any of the prefixes."""
              try:
                  res = subprocess.run(
                      ["gh", "api", f"repos/{repo}/issues/{pr_number}/comments"],
                      check=True,
                      capture_output=True,
                      text=True,
                  )
                  comments = json.loads(res.stdout)
              except Exception:
                  return

              for comment in comments:
                  cbody = comment.get("body", "")
                  if any(cbody.startswith(prefix) for prefix in prefixes):
                      subprocess.run(
                          ["gh", "api", f"repos/{repo}/issues/comments/{comment['id']}", "-X", "DELETE"],
                          check=False,
                      )

          def extract_value(label):
              # label expects a regex fragment, e.g., r"project\s*number"
              pattern = rf"{label}\s*:\s*(.+)"
              # Ignore HTML comments so guidance text does not get parsed as values
              scrubbed = re.sub(r"<!--.*?-->", "", body, flags=re.DOTALL)
              match = re.search(pattern, scrubbed, flags=re.IGNORECASE)
              if not match:
                  return None
              value = match.group(1).strip()
              # Strip common Markdown wrappers (**value**, `value`)
              value = re.sub(r"^[*_`]+|[*_`]+$", "", value).strip()
              return value

          raw_number = extract_value(r"project\s*number")
          raw_name = extract_value(r"project\s*name")

          if not raw_number:
              errors.append("❌ Missing Project Number. Please add: **Project Number:** 013")
          elif not re.fullmatch(r"\d+", raw_number):
              errors.append("❌ Invalid Project Number. Use digits only (e.g., 013).")

          if not raw_name:
              errors.append("❌ Missing Project Name. Please add: **Project Name:** mechanical_refactor_score")
          else:
              if not re.fullmatch(r"[a-z0-9_]+", raw_name):
                  errors.append("❌ Invalid Project Name. Use lowercase snake_case (e.g., mechanical_refactor_score).")

          failure_prefix = "❌ PR Validation Failed"
          success_prefix = "✅ PR Validation Passed"

          if errors:
              delete_comments_with_prefixes((failure_prefix, success_prefix))
              message = failure_prefix + ":\n" + "\n".join(f"- {e}" for e in errors) + "\n\nPlease include both fields in the description:\n- **Project Number:** 013\n- **Project Name:** mechanical_refactor_score"
              subprocess.run(["gh", "pr", "comment", pr_number, "--body", message], check=False)
              subprocess.run(["gh", "label", "create", "needs-info", "--color", "c5def5", "--description", "PR needs required info", "--force"], check=False)
              subprocess.run(["gh", "pr", "edit", pr_number, "--add-label", "needs-info"], check=False)
              sys.exit(1)

          # Passed validation, normalize values
          project_number = raw_number
          project_name = raw_name.lower()
          folder = f"BD-RL-{project_number.zfill(3)}-{project_name}"

          delete_comments_with_prefixes((failure_prefix, success_prefix))
          # Remove failure label if present now that validation passed
          subprocess.run(["gh", "pr", "edit", pr_number, "--remove-label", "needs-info"], check=False)

          if gout:
              with open(gout, "a", encoding="utf-8") as f:
                  f.write(f"project_number={project_number}\n")
                  f.write(f"project_name={project_name}\n")
                  f.write(f"target_folder={folder}\n")
          PY
